#! /usr/bin/env bash

set -Eeo pipefail

BUILD_BENCH=${BUILD_BENCH:-OFF}
BUILD_TESTS=${BUILD_TESTS:-OFF}
BUILD_EXAMPLES=${BUILD_EXAMPLES:-OFF}
CUDA_LINEINFO=${CUDA_LINEINFO:-OFF}
CUDA_KERNELINFO=${CUDA_KERNELINFO:-OFF}
DISABLE_DEPRECATION_WARNINGS=${DISABLE_DEPRECATION_WARNINGS:-ON}

BUILD_CUML_MG_TESTS=OFF
BUILD_CUML_MG_BENCH=OFF
ENABLE_CUMLPRIMS_MG=OFF

if [[ -d "$(cpp-binary-dir --project=cumlprims_mg)" ]]; then
    ENABLE_CUMLPRIMS_MG=ON
fi

if [[ $ENABLE_CUMLPRIMS_MG != OFF ]]; then
    BUILD_CUML_MG_TESTS=${BUILD_TESTS}
    BUILD_CUML_MG_BENCH=${BUILD_BENCH}
fi

configure-cpp \
    --project=cuml \
    --url="${CUML_URL:-}" \
    --out="${CUML_OUT:-}" \
    --branch="${CUML_BRANCH:-}" \
    \
    -D rmm_ROOT="$(cpp-binary-dir --project=rmm)" \
    -D raft_ROOT="$(cpp-binary-dir --project=raft)" \
    -D cumlprims_mg_ROOT="$(cpp-binary-dir --project=cumlprims_mg)" \
    \
    -D DETECT_CONDA_ENV=OFF \
    \
    -D BUILD_CUML_BENCH=${BUILD_BENCH} \
    -D BUILD_CUML_TESTS=${BUILD_TESTS} \
    -D BUILD_PRIMS_TESTS=${BUILD_TESTS} \
    -D BUILD_CUML_EXAMPLES=${BUILD_EXAMPLES} \
    \
    -D CUDA_ENABLE_LINE_INFO=${CUDA_LINEINFO} \
    -D CUDA_ENABLE_KERNEL_INFO=${CUDA_KERNELINFO} \
    \
    -D ENABLE_CUMLPRIMS_MG=${ENABLE_CUMLPRIMS_MG} \
    -D BUILD_CUML_MG_TESTS=${BUILD_CUML_MG_TESTS} \
    -D BUILD_CUML_PRIMS_BENCH=${BUILD_CUML_MG_BENCH} \
    -D BUILD_CUML_STD_COMMS=${BUILD_CUML_STD_COMMS:-ON} \
    -D BUILD_CUML_MPI_COMMS=${BUILD_CUML_MPI_COMMS:-OFF} \
    -D BUILD_CUML_C_LIBRARY=${BUILD_CUML_C_LIBRARY:-OFF} \
    -D BUILD_CUML_CPP_LIBRARY=${BUILD_CUML_CPP_LIBRARY:-ON} \
    -D DISABLE_DEPRECATION_WARNINGS=${DISABLE_DEPRECATION_WARNINGS} \
    ${@};
