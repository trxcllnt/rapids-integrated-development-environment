#! /usr/bin/env bash

set -Eeox pipefail

export DEBIAN_FRONTEND=noninteractive

# ensure conda environment is always activated
ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh;
echo ". /opt/conda/etc/profile.d/conda.sh; conda activate base" >> /etc/skel/.bashrc;
echo ". /opt/conda/etc/profile.d/conda.sh; conda activate base" >> ~/.bashrc;

# Install expected Python version
conda config --system --set always_yes yes;
mamba update --all -y;
mamba install -y python="${PYTHON_VERSION}";

#######################################################
# Install sccache
#######################################################
tar -C /usr/bin -f /usr/src/sccache.tar.gz \
    --wildcards --strip-components=1 -x */sccache \
 && chmod +x /usr/bin/sccache
