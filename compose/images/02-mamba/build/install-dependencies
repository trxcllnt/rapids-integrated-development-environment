#! /usr/bin/env bash

export DEBIAN_FRONTEND=noninteractive

# https://github.com/moby/buildkit/blob/b8462c3b7c15b14a8c30a79fad298a1de4ca9f74/frontend/dockerfile/docs/syntax.md#example-cache-apt-packages
rm -f /etc/apt/apt.conf.d/docker-clean;
echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache

# ensure conda environment is always activated
ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh;
echo ". /opt/conda/etc/profile.d/conda.sh; conda activate base" >> /etc/skel/.bashrc;
echo ". /opt/conda/etc/profile.d/conda.sh; conda activate base" >> ~/.bashrc;

# Install expected Python version
conda config --system --set always_yes yes;
mamba update --all -y;
mamba install -y python="${PYTHON_VERSION}";

#######################################################
# Install sccache
#######################################################
tar -C /usr/bin -f /usr/local/src/sccache.tar.gz \
    --wildcards --strip-components=1 -x */sccache \
 && chmod +x /usr/bin/sccache
