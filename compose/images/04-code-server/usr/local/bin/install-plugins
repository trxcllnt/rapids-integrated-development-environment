#! /usr/bin/env bash

set -Eeou pipefail

_reverse() {
    set +u;
    ary=${@}; eval eval echo "'\"\${ary['{$((${#ary[@]}-1))..0}']}\"'";
}
_join() {
    local IFS='' delim=$1; shift; echo -n "$1"; shift; echo -n "${*/#/$delim}";
}

# Transform path to each plugin command of the form:
#   `$plugins/rmm/cpp/build`
# into symlinks of the form:
#   `/usr/bin/build-rmm-cpp`

for base in /opt/builder/plugins "$HOME/.plugins"; do
    if [[ ! -d "$base" ]]; then
        continue;
    fi;
    for path in $(find "$base" -type f); do
        path="${path#$base/}";
        dirn="$(dirname "$path")";
        dirn="${dirn#.}";
        # split dirname into array on /
        ary=$(IFS=/; echo $dirn);
        # reverse the array and join the contents
        cmd=$(_join - $(basename "$path") $(_reverse $ary));
        # set up the update-alternatives symlinks
        (sudo update-alternatives --remove-all $cmd &>/dev/null || true);
        (sudo update-alternatives --install "/usr/bin/$cmd" $cmd "$base/$path" 999 &>/dev/null || true);
    done;
done

exec "$@";
