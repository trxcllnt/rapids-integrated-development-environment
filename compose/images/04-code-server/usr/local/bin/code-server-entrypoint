#! /usr/bin/env bash

set -Eeuo pipefail

if [[ ! "$(cat /etc/group | grep -F "docker")" ]]; then
    sudo groupadd -g ${DOCKERD_GROUP:-998} docker
fi

if [[ ! "$(id -nGz "$USER" | grep -zxF "docker")" ]]; then
    sudo usermod -aG docker "$USER"
fi

# https://stackoverflow.com/a/63311331/3117331
sudo chgrp docker $(which docker)
sudo chmod g+s $(which docker)

if [[ ! "${PORT:-}" ]]; then
    PORT=8080
fi

mkdir -p "$HOME/.envs";
mkdir -p "$HOME/.config";
mkdir -p "$HOME/.vscode-server";
mkdir -p "$HOME/.local/share/code-server";

# Set up symlinks so connecting to this container via VSCode Remote Containers also works
ln -sf "$HOME/.local/share/code-server" "$HOME/.vscode-server/data";
ln -sf "$HOME/.local/share/code-server/extensions" "$HOME/.vscode-server/extensions";
ln -sf "$HOME/.local/share/code-server/CachedExtensionVSIXs" "$HOME/.vscode-server/extensionsCache";

exec dumb-init /usr/bin/code-server --bind-addr "0.0.0.0:$PORT" "$HOME" "$@";
