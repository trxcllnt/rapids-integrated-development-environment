#! /usr/bin/env bash

set -Eeuo pipefail

# We do this first to ensure sudo works below when renaming the user.
# Otherwise the current container UID may not exist in the passwd database.
eval "$(fixuid -q)"

# if [[ -n "${DOCKER_USER:-}" ]]; then
#     USER="$DOCKER_USER"
#     if [[ "$USER" != "$(whoami)" ]]; then
#         echo "$USER ALL=(ALL) NOPASSWD:ALL" | sudo tee -a /etc/sudoers.d/nopasswd > /dev/null
#         # Unfortunately we cannot change $HOME as we cannot move any bind mounts
#         # nor can we bind mount $HOME into a new home as that requires a privileged container.
#         # sudo usermod --login "$USER" rapids
#         # sudo groupmod -n "$USER" rapids
#         sudo useradd \
#             --non-unique \
#             --uid $(id -u) \
#             --gid $(id -g) \
#             --no-create-home \
#             --shell /bin/bash \
#             --home-dir "$HOME" \
#             "$USER"
#         # sudo sed -i "/rapids/d" /etc/sudoers.d/nopasswd
#         sudo sed -i "s/user: rapids/user: $USER/g" /etc/fixuid/config.yml
#         sudo sed -i "s/group: rapids/group: $USER/g" /etc/fixuid/config.yml
#     fi
# fi

if [[ -n "${DOCKER_USER_HOME:-}" ]]; then
    if [[ "$DOCKER_USER_HOME" != "$HOME" ]]; then
        mkdir -p "$DOCKER_USER_HOME"
        # sudo usermod -d "$DOCKER_USER_HOME" rapids
        sudo usermod -d "$DOCKER_USER_HOME" "$USER"
        sudo sed -i "s@/opt/rapids@$DOCKER_USER_HOME@g" /etc/fixuid/config.yml
        touch "$HOME"/.{bashrc,eternal_bash_history}
        if [[ ! -f "$DOCKER_USER_HOME"/.bashrc ]]; then
            cp "$HOME"/.bashrc "$DOCKER_USER_HOME"/.bashrc
        fi
        if [[ ! -f "$DOCKER_USER_HOME"/.eternal_bash_history ]]; then
            cp "$HOME"/.eternal_bash_history "$DOCKER_USER_HOME"/.eternal_bash_history
        fi
        HOME="$DOCKER_USER_HOME"
    fi
fi

mkdir -p "$HOME/.local/share/code-server"
ln -sf "$HOME/.local/share/code-server" "$HOME/.vscode-server"

if [[ ! "$(cat /etc/group | grep -F "docker")" ]]; then
    sudo groupadd -g ${DOCKERD_GROUP:-998} docker
fi

if [[ ! "$(id -nGz "$USER" | grep -zxF "docker")" ]]; then
    sudo usermod -aG docker "$USER"
fi

# https://stackoverflow.com/a/63311331/3117331
sudo chgrp docker $(which docker)
sudo chmod g+s $(which docker)

#######################################################
# Install code-server extensions
#######################################################
(
install_code_server_extensions() {
    for EXT in ${@:2}; do
        if [ ! "$(code-server --list-extensions | grep $EXT)" ]; then
            code-server --install-extension $EXT
        fi
    done
}

install_code_server_extensions                \
    `# CMake language support`                \
    twxs.cmake                                \
    `# Clang-Format`                          \
    xaver.clang-format                        \
    `# Doxygen Documentation Generator`       \
    cschlosser.doxdocgen

# Tasks Shell Input
if [ ! "$(code-server --list-extensions | grep augustocdias.tasks-shell-input)" ]; then
    code-server --install-extension /usr/local/src/tasks-shell-input.vsix || true;
fi
# MS C++ Tools
if [ ! "$(code-server --list-extensions | grep ms-vscode.cpptools)" ]; then
    code-server --install-extension /usr/local/src/ms-vscode.cpptools.vsix || true;
fi
# NVIDIA Nsight
if [ ! "$(code-server --list-extensions | grep nvidia.nsight-vscode-edition)" ]; then
    code-server --install-extension /usr/local/src/nsight-vscode.vsix || true;
fi
)

if [[ ! "${PORT:-}" ]]; then
    PORT=8080
fi

mkdir -p "$HOME/rapids"

exec cpp-builder-entrypoint dumb-init /usr/bin/code-server --bind-addr "0.0.0.0:$PORT" "$HOME/rapids" "$@"
