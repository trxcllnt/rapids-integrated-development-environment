#! /usr/bin/env bash
set -Eeo pipefail;
cd "$(dirname "$(realpath "$0")")";
if [[ -d "$HOME/rapids/cugraph" ]]; then

    tmp_env_file="$(mktemp)";
    touch "$HOME/rapids/.config/cpp.env" "$tmp_env_file";

    cat "$HOME/rapids/.config/cpp.env" >> "$tmp_env_file";

    if [ -n ${BUILD_TYPE:-} ]; then
        echo "BUILD_TYPE=$BUILD_TYPE" >> "$tmp_env_file";
        sed -ir "s/^BUILD_TYPE=\w+\$/BUILD_TYPE=$BUILD_TYPE/g" "$tmp_env_file";
    fi
    if [ -n ${BUILD_TESTS:-} ]; then
        echo "BUILD_TESTS=$BUILD_TESTS" >> "$tmp_env_file";
        sed -ir "s/^BUILD_TESTS=\w+\$/BUILD_TESTS=$BUILD_TESTS/g" "$tmp_env_file";
    fi
    if [ -n ${BUILD_BENCH:-} ]; then
        echo "BUILD_BENCH=$BUILD_BENCH" >> "$tmp_env_file";
        sed -ir "s/^BUILD_BENCH=\w+\$/BUILD_BENCH=$BUILD_BENCH/g" "$tmp_env_file";
    fi

    on_exit() {
        ERRCODE="$?";
        rm -f "$tmp_env_file" >/dev/null 2>&1 || true;
        exit "$ERRCODE";
    }

    trap on_exit ERR EXIT HUP INT QUIT TERM STOP PWR;

    (
    set -a && source "$tmp_env_file" && set +a;

    if [[ -d "$HOME/rapids/cugraph" ]]; then
        echo "CUGRAPH_SOURCE_DIR=$HOME/rapids/cugraph" >> "$tmp_env_file";
        echo "CUGRAPH_CPP_SOURCE_DIR=$(cpp-source-dir-util --project=cugraph)" >> "$tmp_env_file";
        echo "CUGRAPH_CPP_BINARY_DIR=$(cpp-binary-dir-util --project=cugraph)" >> "$tmp_env_file";
    fi
    if [[ -d "$HOME/rapids/rmm" ]]; then
        echo "RMM_SOURCE_DIR=$HOME/rapids/rmm" >> "$tmp_env_file";
        echo "RMM_CPP_SOURCE_DIR=$(cpp-source-dir-util --project=rmm)" >> "$tmp_env_file";
        echo "RMM_CPP_BINARY_DIR=$(cpp-binary-dir-util --project=rmm)" >> "$tmp_env_file";
    fi
    if [[ -d "$HOME/rapids/raft" ]]; then
        echo "RAFT_SOURCE_DIR=$HOME/rapids/raft" >> "$tmp_env_file";
        echo "RAFT_CPP_SOURCE_DIR=$(cpp-source-dir-util --project=raft)" >> "$tmp_env_file";
        echo "RAFT_CPP_BINARY_DIR=$(cpp-binary-dir-util --project=raft)" >> "$tmp_env_file";
    fi
    if [[ -d "$HOME/rapids/cugraph-ops" ]]; then
        echo "CUGRAPH_OPS_SOURCE_DIR=$HOME/rapids/cugraph-ops" >> "$tmp_env_file";
        echo "CUGRAPH_OPS_CPP_SOURCE_DIR=$(cpp-source-dir-util --project=cugraph-ops)" >> "$tmp_env_file";
        echo "CUGRAPH_OPS_CPP_BINARY_DIR=$(cpp-binary-dir-util --project=cugraph-ops)" >> "$tmp_env_file";
    fi

    volumes="";
    if [[ -d "$HOME/rapids/cugraph" ]]; then volumes+="-v $HOME/rapids/cugraph:$HOME/rapids/cugraph "; fi
    if [[ -d "$HOME/rapids/rmm" ]]; then volumes+="-v $HOME/rapids/rmm:$HOME/rapids/rmm:ro "; fi
    if [[ -d "$HOME/rapids/raft" ]]; then volumes+="-v $HOME/rapids/raft:$HOME/rapids/raft:ro "; fi
    if [[ -d "$HOME/rapids/cugraph-ops" ]]; then volumes+="-v $HOME/rapids/cugraph-ops:$HOME/rapids/cugraph-ops:ro "; fi

    docker run \
        --rm -it --runtime nvidia \
        --env-file "$tmp_env_file" \
        --name "configure-cugraph-cpp-$(basename "$tmp_env_file")" \
        ${volumes} \
        pauletaylor/rapids-ide:cpp-builder-cuda11.6.0-ubuntu20.04 \
        bash -c '
        pids=""; \
        bash -l <<< "copy-inputs-util --project=\"rmm\" --src=\"\$RMM_SOURCE_DIR\" --bin=\"\$RMM_CPP_BINARY_DIR\"" & \
        pids="${pids:+$pids }$!";
        bash -l <<< "copy-inputs-util --project=\"raft\" --src=\"\$RAFT_SOURCE_DIR\" --bin=\"\$RAFT_CPP_BINARY_DIR\"" & \
        pids="${pids:+$pids }$!";
        bash -l <<< "copy-inputs-util --project=\"cugraph-ops\" --src=\"\$CUGRAPH_OPS_SOURCE_DIR\" --bin=\"\$CUGRAPH_OPS_CPP_BINARY_DIR\"" & \
        pids="${pids:+$pids }$!";
        bash -l <<< "copy-inputs-util --project=\"cugraph\" --src=\"\$CUGRAPH_SOURCE_DIR\" --bin=\"\$CUGRAPH_CPP_BINARY_DIR\"" & \
        pids="${pids:+$pids }$!";
        wait ${pids}; \
        configure-cugraph-cpp "${@}" 2>&1 \
          | sed -r "s@/opt/rapids/rmm/build@$RMM_CPP_BINARY_DIR@g" \
          | sed -r "s@$(realpath -m "/opt/rapids/rmm/$(realpath -m --relative-to="$RMM_SOURCE_DIR" "$RMM_CPP_SOURCE_DIR")")@$RMM_CPP_SOURCE_DIR@g" \
          | sed -r "s@ build/@ $(realpath -m --relative-to="$RMM_CPP_SOURCE_DIR" "$RMM_CPP_BINARY_DIR")/@g" \
          | sed -r "s@/opt/rapids/raft/build@$RAFT_CPP_BINARY_DIR@g" \
          | sed -r "s@$(realpath -m "/opt/rapids/raft/$(realpath -m --relative-to="$RAFT_SOURCE_DIR" "$RAFT_CPP_SOURCE_DIR")")@$RAFT_CPP_SOURCE_DIR@g" \
          | sed -r "s@ build/@ $(realpath -m --relative-to="$RAFT_CPP_SOURCE_DIR" "$RAFT_CPP_BINARY_DIR")/@g" \
          | sed -r "s@/opt/rapids/cugraph-ops/build@$CUGRAPH_OPS_CPP_BINARY_DIR@g" \
          | sed -r "s@$(realpath -m "/opt/rapids/cugraph-ops/$(realpath -m --relative-to="$CUGRAPH_OPS_SOURCE_DIR" "$CUGRAPH_OPS_CPP_SOURCE_DIR")")@$CUGRAPH_OPS_CPP_SOURCE_DIR@g" \
          | sed -r "s@ build/@ $(realpath -m --relative-to="$CUGRAPH_OPS_CPP_SOURCE_DIR" "$CUGRAPH_OPS_CPP_BINARY_DIR")/@g" \
          | sed -r "s@/opt/rapids/cugraph/build@$CUGRAPH_CPP_BINARY_DIR@g" \
          | sed -r "s@$(realpath -m "/opt/rapids/cugraph/$(realpath -m --relative-to="$CUGRAPH_SOURCE_DIR" "$CUGRAPH_CPP_SOURCE_DIR")")@$CUGRAPH_CPP_SOURCE_DIR@g" \
          | sed -r "s@ build/@ $(realpath -m --relative-to="$CUGRAPH_CPP_SOURCE_DIR" "$CUGRAPH_CPP_BINARY_DIR")/@g"; \
        copy-output-util --project="cugraph" --src="$CUGRAPH_CPP_SOURCE_DIR" --bin="$CUGRAPH_CPP_BINARY_DIR";' _ "${@}";
    )
fi
